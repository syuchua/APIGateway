# 日志审计方案草案

本文档用于梳理当前 API Gateway 项目的审计日志范围、采集策略与落地计划，作为后续实现的设计基础。

## 1. 审计目标

- **合规留痕**：记录用户在系统管理（用户、密钥、配置）、策略变更等敏感操作。
- **问题追踪**：在异常发生时快速定位执行人、操作内容与执行结果。
- **安全预警**：为后续的告警体系提供数据基础，识别高危操作或重复失败尝试。

## 2. 审计范围初稿

| 分类 | 操作 | 说明 |
| ---- | ---- | ---- |
| 认证 | 登录、登出、token 刷新 | 记录账号、来源 IP、成功/失败原因 |
| 用户管理 | 创建、编辑、禁用、重置密码 | 记录目标账号、角色变更、执行人 |
| 密钥管理 | 创建、激活、停用、删除密钥 | 记录密钥ID、操作类型、结果 |
| 系统配置 | 配置修改、备份、恢复、重启 | 记录变更内容（脱敏处理）、执行人 |
| 策略变更 | 路由规则、目标系统、数据源的增删改 | Already partially covered via MessageLog，可扩展审计字段 |
| 安全事件 | 多次失败、异常访问 | 作为扩展事件来源 |

## 3. 数据模型草案

```jsonc
{
  "id": "uuid",
  "timestamp": "2025-10-16T10:00:00Z",
  "actor": {
    "user_id": "uuid",
    "username": "admin",
    "role": "admin",
    "ip": "127.0.0.1"
  },
  "action": "user.update",
  "resource": {
    "type": "user",
    "id": "uuid",
    "name": "operator"
  },
  "result": "success", // success / failed / denied
  "before": { ... }, // 可选，注意敏感字段脱敏
  "after": { ... },
  "message": "将角色从 operator 调整为 admin"
}
```

## 4. 采集方式

1. **后端 API Hook**：在关键 API 成功/失败返回前写入审计记录（可使用 FastAPI 中间件或 service 层统一入口）。
2. **事件驱动**：针对路由任务等异步操作，可在事件总线（eventbus）中发布审计事件，由专用 Handler 落库。
3. **与 MessageLog 区分**：审计日志强调“谁对系统做了什么”，而 MessageLog 面向数据转发。宜独立表结构，如 `gateway.audit_logs`。

## 5. 存储与保留

- **表结构**：PostgreSQL，按月份分区或使用 `created_at` 索引，支持批量导出。
- **保留策略**：默认 180 天，可配置；支持导出归档。
- **脱敏处理**：敏感字段（密钥、密码）仅记录摘要或哈希，避免明文存储。

## 6. 展示与查询

- **前端页面**：系统管理 => “审计日志”页签，支持按时间、用户、操作类型过滤。
- **导出接口**：支持 CSV/JSON 导出，供安全运营分析。

## 7. 实施路线

1. 设计数据库表结构及 ORM 模型。
2. 编写审计记录 service，统一收集写入。
3. 对现有关键 API 打点（用户、密钥、配置、路由等）。
4. 开发前端审计列表页，支持基本过滤展示。
5. 结合告警系统，规划高危操作的实时告警。

## 8. 未决事项

- 具体字段脱敏准则（例如配置变更的差异记录方式）。
- 操作来源（API vs. UI）区分策略。
- 与外部 SIEM 或日志平台的对接需求。

---
后续可基于本草案分解任务，并在优先级合适时实施。
