# 协议适配器设计说明

## 帧格式解析的适用范围

### ✅ 需要帧格式解析的协议

**UDP协议适配器**
- UDP是无连接的数据报协议，通常传输原始二进制数据
- 数据没有内置的结构化格式，需要通过帧格式定义来解析
- 典型应用场景：
  - 工业传感器数据（温度、湿度、压力等）
  - 物联网设备上报
  - 自定义二进制协议

**TCP协议适配器（部分场景）**
- TCP是面向连接的流式协议
- 如果应用层使用自定义二进制协议，需要帧格式解析
- 如果应用层使用结构化协议（如HTTP、JSON over TCP），则不需要

### ❌ 不需要帧格式解析的协议

**HTTP协议适配器**
- HTTP传输的数据通常已经是结构化格式（JSON、XML、Form-data等）
- 应用层由FastAPI直接解析和验证
- 特殊场景：如果HTTP body是原始二进制数据，可以选择性启用帧解析（罕见）

**WebSocket协议适配器**
- WebSocket通常传输文本（JSON）或结构化二进制消息
- 应用层自行处理消息格式，不需要帧解析
- 特殊场景：如果WebSocket传输自定义二进制协议，可以启用帧解析

**MQTT协议适配器**
- MQTT payload通常是JSON或其他结构化格式
- 不需要帧格式解析

## 适配器实现要点

### 统计信息

**基类提供的统计项** (BaseAdapter)
```python
self._stats = {
    "messages_received": 0,     # 接收到的消息数
    "messages_published": 0,    # 发布到EventBus的消息数
    "errors": 0,                # 错误次数
    "bytes_received": 0         # 接收的字节数
}
```

**子类扩展统计项**
各协议适配器可以根据自己的需求扩展统计项，在`__init__`中添加：
```python
self._stats["messages_processed"] = 0  # 处理完成的消息数
self._stats["connections"] = 0         # 当前连接数（WebSocket/TCP）
```

### 注意事项

1. **避免修改基类**
   - BaseAdapter是所有适配器的基础，修改会影响所有子类
   - 新增功能在子类中实现，不要修改基类的统计字典

2. **帧格式配置是可选的**
   - `frame_schema`参数在基类构造函数中是`Optional`
   - 只有需要解析二进制数据的协议才配置帧格式
   - HTTP/WebSocket/MQTT等协议通常不需要配置

3. **EventBus主题使用**
   - 每个协议有独立的接收主题：`HTTP_RECEIVED`, `UDP_RECEIVED`, `WEBSOCKET_RECEIVED`等
   - 解析成功统一发布到`DATA_PARSED`主题
   - 保持主题命名的一致性

## 已实现的适配器

| 协议 | 状态 | 测试数 | 覆盖率 | 帧解析支持 | 说明 |
|------|------|--------|--------|-----------|------|
| UDP  | ✅   | 15     | 68%    | ✅ 必需   | 原始二进制数据，需要帧格式定义 |
| HTTP | ✅   | 15     | 91%    | ❌ 不支持 | 传输JSON/XML，不需要帧解析 |
| WebSocket | ✅ | 16  | 90%    | ❌ 不支持 | 传输结构化消息，不需要帧解析 |
| TCP  | ✅   | 15     | 88%    | ⚠️ 可选   | 流式协议，可选帧解析 |
| MQTT | ✅   | 15     | 90%    | ❌ 不支持 | Payload已是结构化数据 |

**总计**：5个协议适配器，76个测试，平均覆盖率85.4%

图例：
- ✅ 已完成
- ⏳ 进行中
- 📅 计划中
- ⚠️ 特殊场景可选
- ❌ 不需要
